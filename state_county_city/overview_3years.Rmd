---
title: "General Purpose Government in 3 years: 2020-2021-2022"
output: 
  html_document:
    toc: true
    number_sections: true
    toc_depth: 2
    toc_float: true
date: "2023-11-10"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
options(scipen = 999)
library(tidyverse)
library(dplyr)
library(DT)
library(viridis)
library(janitor)
source("../census.R")
source("../acfrs_gen_purpose_2020.R")
source("../acfrs_gen_purpose_2021.R")
source("acfrs_gen_purpose_2022.R")
```

# State 
```{r}
state_3years <- state_gov_2020 %>% 
  rbind(state_gov_2021) %>% 
  rbind(state_gov_2022) %>% 
  mutate(across(5:28, as.numeric)) %>% 

  mutate(npl_person = round(net_pension_liability/population)) %>% 
  group_by(year) %>% 
  mutate(avg_npl_person = round(mean(npl_person))) %>%
  ungroup()

datatable(state_3years)

state_3years %>% write.csv("output/state_3years.csv")

income <- rio::import(here::here("data", "Unemployment_median income.xlsx"), skip = 4)  %>% 
  select(FIPS_Code, Median_Household_Income_2021) %>% 
  rename(geo_id = FIPS_Code)
  
county_3years %>% left_join(income) %>% write.csv("output/county_3years_urbanicity_income.csv")
```


## State governments: Net Pension Liabilities
```{r fig.width=15, fig.width=15}
state_3years %>% #filter(state.abb == "MI")
  mutate(year = as.factor(year)) %>% 
  ggplot(aes(name, net_pension_liability), group = year) +
  geom_col(aes(fill = year), position = "dodge") +
  # scale_color_viridis(discrete=TRUE) +
  scale_y_continuous(breaks = c(50000000000, 100000000000, 150000000000),
                   label = c("$50B", "$100B","$150B")) +
  
    scale_fill_manual(values = c("grey","black","orange")) +
  
  labs(title = "Net Pension Liabilities of State Governments in 3 years: 2020, 2021, 2022",
       x = "",
       y = "Net Pension Liabilities", 
       caption = "Four states have not released 2022 ACFRs: AZ, CA, NV, OK") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60)) 
# 4 are behind:       AZ" "CA" "NV" "OK""
```

## State governments: Net Pension Liabilities Per Person
```{r fig.width=15, fig.width=15}
avg_npl_person <- state_3years %>% select(year, avg_npl_person) %>% distinct()

state_3years %>% 
  mutate(year = as.factor(year)) %>% 
  ggplot(aes(name, npl_person), group = year) +
  geom_col(aes(fill = year), position = "dodge") +
  
  geom_hline(yintercept = 2002, color="grey") +
  geom_hline(yintercept = 2206, color="black") +
  geom_hline(yintercept = 1356, color="orange") +
  annotate("text", label = "Average NPL\nper person", x = 49, y = 2700) +
  
    scale_fill_manual(values = c("grey","black","orange")) +
  
  labs(title = "Net Pension Liabilities Per Person of State Governments in 3 years: 2020, 2021, 2022",
       x = "",
       y = "Net Pension Liabilities Per Person", 
       caption = "Four states have not released 2022 ACFRs: AZ, CA, NV, OK") +

  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60)) 
```


```{r fig.width=15, fig.width=15, include=FALSE}
## State governments: Total Liabilities
state_3years %>% #filter(state.abb == "CA")
  mutate(year = as.factor(year)) %>% 
  ggplot(aes(name, total_liabilities), group = year) +
  geom_col(aes(fill = year), position = "dodge") +
  # scale_color_viridis(discrete=TRUE) +
  scale_y_continuous(breaks = c(100000000000, 200000000000,300000000000, 400000000000, 500000000000),
                   label = c("$100B","$200B", "$300B", "$400B", "$500B")) +
  
    scale_fill_manual(values = c('#D9AF6B', '#AF6458', '#68855C')) +
  
  labs(title = "Total Liabilities of State Governments in 3 years: 2020, 2021, 2022",
       x = "",
       y = "Total Liabilities", 
       caption = "Four states have not released 2022 ACFRs: AZ, CA, NV, OK\n Four states whose ACFRs are being processed: HI, IL, MT, NM") +

  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) 
```


```{r fig.width=15, fig.width=15, , include=FALSE}
## State governments: Revenues
state_3years %>% #filter(state.abb == "CA")
  mutate(year = as.factor(year)) %>% 
  ggplot(aes(name, revenues), group = year) +
  geom_col(aes(fill = year), position = "dodge") +
  # scale_color_viridis(discrete=TRUE) +
  scale_y_continuous(breaks = c(100000000000, 200000000000,300000000000, 400000000000, 500000000000),
                   label = c("$100B","$200B", "$300B", "$400B", "$500B")) +
  
    scale_fill_manual(values = c('#526A83', '#625377', '#68855C')) +
  labs(title = "Revenues of State Governments in 3 years: 2020, 2021, 2022",
       x = "",
       y = "Revenues", 
       caption = "Four states have not released 2022 ACFRs: AZ, CA, NV, OK\n Four states whose ACFRs are being processed: HI, IL, MT, NM") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) 
```

## State Urbanicity 

```{r}
mod_data_state <- state_3years %>% 
  rename(urban_pop = x2020_urban_pop,
         urban_pop_pct = x2020_pct_urban_pop) %>% 
  mutate(net_pension_liability = net_pension_liability+1,
         urban_pop = urban_pop+1) 

mod_data_state %>% 
  ggplot(aes(urban_pop, net_pension_liability))+
  geom_point(color = "orange", alpha = 0.3) +
  #scale_x_log10() +
  #scale_y_log10()+
  theme_minimal() +
  labs(title = "Urbanicity & Net Pension Liability: Raw scale")
```

```{r}

mod_data_state %>% 
  ggplot(aes(urban_pop, net_pension_liability))+
  geom_point(color = "orange", alpha = 0.3) +
  scale_x_log10() +
  scale_y_log10()+
  theme_minimal() +
  labs(title = "Urbanicity & Net Pension Liability: Log scales",
       x = "Urban population",
       y = "Net Pension Liability",
       caption = "Log scales interpretation: For every 1% increase in urban population, there's a 1.27% increase in net pension liability ")
  
```

```{r}
mod_state <- lm(log(net_pension_liability) ~ log(urban_pop), data = mod_data_state)
summary(mod_state)
```

# County

## All counties collected in 3 years 2020, 2021, 2022
```{r}
income <- rio::import(here::here("data", "Unemployment_median income.xlsx"), skip = 4)  %>% 
  select(FIPS_Code, Median_Household_Income_2021) %>% 
  rename(geo_id = FIPS_Code)

county_3years <- county_gov_20 %>% rbind(county_gov_21) %>% rbind(county_gov_22) %>% 
  select(-c(geo_id.x, government_id)) %>% 
  rename(geo_id = geo_id.y) %>%  left_join(income) %>% drop_na(Median_Household_Income_2021)

datatable(county_3years)
colnames(county_3years)
  
county_3years %>% 
  write.csv("output/county_3years_urbanicity_income.csv")
```

## Viz Urbanicity

```{r}
county_3years %>% 
  ggplot(aes(pop_urb, net_pension_liability))+
  geom_point(color = "cornflowerblue", alpha = 0.3) +
  #scale_x_log10() +
  #scale_y_log10()+
  theme_minimal() +
  labs(title = "County government: Urban population & Net Pension Liability/n Raw scale")
```

```{r}
county_3years %>% 
  ggplot(aes(pop_urb, net_pension_liability))+
  geom_point(color = "cornflowerblue", alpha = 0.3) +
  scale_x_log10() +
  scale_y_log10()+
  theme_minimal() +
  labs(title = "County government: Urbanicity & Net Pension Liability: Log scales",
       x = "Urban population",
       y = "Net Pension Liability",
       caption = "Log scales interpretation: For every 1% increase in urban population, there's a 0.42% increase in net pension liability")

```

```{r}
mod_data_county <- county_3years %>% 
  mutate(net_pension_liability = net_pension_liability+1,
         pop_urb = pop_urb+1) %>% 
  select(net_pension_liability, pop_urb) 

mod_county <- lm(log(net_pension_liability) ~ log(pop_urb), data = mod_data_county)
summary(mod_county)

#Interpretation:
#https://library.virginia.edu/data/articles/interpreting-log-transformations-in-a-linear-model

```

```{r, include=FALSE, eval=FALSE}
plot(mod1, which = 3)
# The trend line is even BUT the residual are clustered. ==> Violate the constant variance assumption --> the model is misspecified. 
```

## Viz Median income
```{r inclue = FALSE, eval=FALSE}

income_mod_data <- county_3years %>% left_join(income) %>% 
 mutate(net_pension_liability = net_pension_liability +1)

income_mod_data %>% 
  ggplot(aes(Median_Household_Income_2021, net_pension_liability)) +
  geom_point(color = "purple", alpha = .3) +
  theme_minimal()+
  scale_x_log10()+
  scale_y_log10()+
  labs(title = "County government: Median household income & Net pension liability",
       caption = "Log scales interpretation: For every 1% increase in household median income,\nthere's a 6.3% increase in net pension liability")
```

```{r}
income_mod_data
income_mod_county <- lm(log(net_pension_liability) ~ log(Median_Household_Income_2021), data = income_mod_data)
summary(income_mod_county)
```


## The 100 most populous counties in 3 years:

This list of Census top 100 counties:

* only includes counties categorized as "A" - active government or "C" - Active government consolidated with another government with a single set of
officials

* excludes these NY counties: "kings county", "queens county", "new york county", "bronx county"

* excludes these MA counties: Middlesex, MA Massachusetts, MA essex county, MA suffolk as they are nonfunctioning legal entities.


```{r include = FALSE}
##### Top 100 acfrs counties 2020
# Find acfrs entities from the list of Top 100 county census
acfrs_topcounty_20 <- county_3years %>% 
  filter(geo_id %in% census_county_top100$geo_id) %>% filter(year == 2020) 

 # select(-c(place, concit, cousub, place, funcstat, state.name, county, state)) 
# These county are consolidated. They have some other name in acfrs list: [1] PA "philadelphia county"  FL"duval county"       CA  "san francisco county" "will county"   
  
#these are counted as cities. Need to find in incorp_division_gov_21
acfrs_top100county_20 <- place_division_gov_20 %>% 
  add_column(pop_urb = NA, poppct_urb = NA) %>% 
  filter(name == "san francisco" & state.abb == "CA" | 
  name == "philadelphia" & state.abb == "PA" | 
  name == "jacksonville" & state.abb == "FL") %>% 
  # being processed
  add_row(state.abb = "MA", name = "norfolk county", id = 116575, net_pension_liability = 0, population = 725999, year = 2020, pop_urb = NA, poppct_urb = NA) %>% 
  select(-c(name_census, government_id)) %>% 
  
  #bind with 96 top county 
  rbind(acfrs_topcounty_20) 
```



```{r include = FALSE}
## Top 100 acfrs counties 2021
acfrs_topcounty_21 <- county_3years %>% 
  filter(geo_id %in% census_county_top100$geo_id) %>% filter(year == 2021)
  
acfrs_top100county_21 <- place_division_gov_21 %>% 
  add_column(pop_urb = NA, poppct_urb = NA) %>% 
  filter(name == "san francisco" & state.abb == "CA" | 
  name == "philadelphia" & state.abb == "PA" | 
  name == "jacksonville" & state.abb == "FL") %>% 
  # TODO: check will county to be processed in portal later. 
  #add_row(state.abb = "IL", name = "will county", id = 32790, net_pension_liability = 45000000, population = 697985, year = 2021) %>% 
  select(-c(name_census, government_id)) %>% 
  
  #bind with 96 top county 
  rbind(acfrs_topcounty_21) 
```


```{r include = FALSE}
## Top 100 acfrs counties 2022
acfrs_topcounty_22 <- county_3years %>% 
  filter(geo_id %in% census_county_top100$geo_id) %>% filter(year == 2022) 

acfrs_top100county_22 <- place_division_gov_22 %>% 
  add_column(pop_urb = NA, poppct_urb = NA) %>% 
  filter(name == "san francisco" & state.abb == "CA" | 
  name == "philadelphia" & state.abb == "PA" | 
  name == "jacksonville" & state.abb == "FL") %>% 
  #TODO: uploaded 2022 files. Check back. 
  add_row(state.abb = "PA", name = "philadelphia", id = 0, net_pension_liability = 5386419000, population = 1603799, year = 2022) %>% 
  add_row(state.abb = "WI", name = "milwaukee county", id = 0, net_pension_liability = 330849000, population = 939495, year = 2022) %>% 
 
  select(-c(name_census, government_id)) %>% 
  rbind(acfrs_topcounty_22) 
  
 # Check what are still missing: has 4
# census_county_top100 %>% filter(name %in% setdiff(census_county_top100$name_census, acfrs_top100county_22$name))

#TODO: still missing these - all are A counties
# OK oklahoma county , MA norfolk county
#OK tulsa county
#GA Fulton: 
```


```{r}
# #Total: 292 counties. 2022 has only 92
county_top100_3years <- acfrs_top100county_20 %>% 
  rbind(acfrs_top100county_21) %>% 
  rbind(acfrs_top100county_22)  #colnames()
  #select(place, concit, cousub, place, funcstat, state.name, county, state)


datatable(county_top100_3years)
county_top100_3years %>% write.csv("output/acfrs_county_top100_3years.csv")


colnames(county_top100_3years)
```
## Top 100 Counties: Net Pension Liabilities

```{r fig.width=15, fig.width=15}
county_top100_3years %>% #filter(name == "jacksonville")
  mutate(year = as.factor(year)) %>% 
  ggplot(aes(name, net_pension_liability), group = year) +
  geom_col(aes(fill = year), position = "dodge") +
  # scale_color_viridis(discrete=TRUE) +
  scale_y_continuous(breaks = c(5000000000, 10000000000, 15000000000),
                  label = c("$5B", "$10B","$15B")) +
  
    scale_fill_manual(values = c('#D9AF6B', '#AF6458', '#68855C')) +
  
  labs(title = "Net Pension Liabilities of The top 100 County Governments in 3 years: 2020, 2021, 2022",
       x = "",
       y = "Net Pension Liabilities", 
       caption = "") +

  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) 
```

## Top 100 Counties: Net Pension Liabilities Per Person

```{r fig.width=15, fig.width=15}
county_top100_3years %>% #filter(name == "jacksonville")
  mutate(year = as.factor(year)) %>% #select(state.abb, name, net_pension_liability, population) %>% 
  mutate(npl_person = net_pension_liability/population) %>% 
  
  ggplot(aes(name, npl_person), group = year) +
  geom_col(aes(fill = year), position = "dodge") +
  # scale_color_viridis(discrete=TRUE) +
  scale_y_continuous(breaks = c(5000000000, 10000000000, 15000000000),
                  label = c("$5B", "$10B","$15B")) +
  
    scale_fill_manual(values = c('#D9AF6B', '#AF6458', '#68855C')) +
  
  labs(title = "Net Pension Liabilities of The top 100 County Governments Per Person\nin 3 years: 2020, 2021, 2022",
       x = "",
       y = "Net Pension Liabilities", 
       caption = "") +

  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) 
```


# Incorporated Place & Minor Civil Division: 

From "Understanding Place in Census.pdf", Incorporated Places are:

• Legally bounded entity

• Cities, boroughs, towns, or villages, depending on the state

• Over 19,000 incorporated places

Includes:
– Cities
– Towns (except in the six New England states, New York, and Wisconsin)
– Villages
– Boroughs (except in New York and Alaska)

Does not include:

– Towns/townships in the Northeast and Midwest

## All Incorporated Place & Minor Civil Division

There are a total of 26,771 incorporated places and minor civil divisions collected for 3 years 2020, 2021, 2021. See the full list named "place_division_3years.csv" in dropbox folder. 

```{r}
place_division_3years <- place_division_gov_22 %>% 
  rbind(place_division_gov_21) %>% 
  rbind(place_division_gov_20)

place_division_3years %>% write.csv("output/place_division_3years.csv")
```



## All Cities collected in 3 years 2020, 2021, 2022
```{r}
city_gov_3years <- city_gov_22 %>% 
  rbind(city_gov_21) %>% 
  rbind(city_gov_20)

city_gov_3years %>% write.csv("output/city_gov_3years.csv")
datatable(city_gov_3years)
```

```{r}
#S1903 MEDIAN INCOME IN THE PAST 12 MONTHS (IN 2021 INFLATION-ADJUSTED DOLLARS)
#2021: ACS 1-Year Estimates Subject Tables
#https://data.census.gov/table/ACSST1Y2021.S1903?q=median%20household%20income%20by%20city%202021&g=010XX00US$0300000

city_income <- rio::import(here::here("data/ACSST1Y2021.S1903_2023-12-29T105538/ACSST1Y2021.S1903-Data.csv"), skip = 1) %>% select(1, `Geographic Area Name`, `Estimate!!Median income (dollars)!!HOUSEHOLD INCOME BY RACE AND HISPANIC OR LATINO ORIGIN OF HOUSEHOLDER!!Households`) %>% 
  rename(Median_Household_Income_2021 = `Estimate!!Median income (dollars)!!HOUSEHOLD INCOME BY RACE AND HISPANIC OR LATINO ORIGIN OF HOUSEHOLDER!!Households`
         ) %>% 
  mutate(
         place = substring(Geography, 12, 16),
         state = substring(Geography, 10, 11)) %>% 
  select(-c(Geography, `Geographic Area Name`))


city_gov_3years %>% left_join(city_income, by = c("place", "state")) %>% 
  write.csv("output/city_3years_median_income.csv")
  
  

city_income

#by = c("geo_id" = "place", "state"



```

## The 100 most populous cities in 3 years
```{r}
# 2021
acfr_top_city_21 <- acfrs_general_purpose_21 %>% 
  
  # mannual add geo_id for those do not have government_id --> can't get geo_id 
  mutate(geo_id = case_when(state.abb == "CA" & name == "san jose" ~ "0668000", 
                            state.abb == "LA" & name == "new orleans" ~ "2255000",
                            state.abb == "NY" & name == "buffalo" ~ "3611000",
                            TRUE ~ as.character(geo_id))) %>% 
  
  filter(geo_id %in% census_city_top100$geo_id) %>% 
  left_join(census_city_top100)

#2020
acfr_top_city_20 <- acfrs_general_purpose_20 %>% 
  mutate(geo_id = case_when(state.abb == "CA" & name == "san jose" ~ "0668000", 
                            state.abb == "LA" & name == "new orleans" ~ "2255000", # being processed
                            state.abb == "NY" & name == "buffalo" ~ "3611000",
                            state.abb == "NJ" & name == "newark" ~ "3451000", # can't find
                            
                            TRUE ~ as.character(geo_id))) %>% 
  filter(geo_id %in% census_city_top100$geo_id) %>% 
  left_join(census_city_top100)

# identify missing 20: 
missing_city_20 <- census_city_top100 %>% filter(geo_id %in% setdiff(census_city_top100$geo_id, acfr_top_city_20$geo_id)) 


#2022
acfr_top_city_22 <- acfrs_general_purpose_22 %>% 
  mutate(geo_id = case_when(state.abb == "CA" & name == "san jose" ~ "0668000", 
                            state.abb == "LA" & name == "new orleans" ~ "2255000", # being processed
                            state.abb == "NY" & name == "buffalo" ~ "3611000",
                            state.abb == "NJ" & name == "newark" ~ "3451000", # can't find
                            state.abb == "PA" & name == "philadelphia" ~ "4260000", #being processed
                            state.abb == "CA" & name == "bakersfield" ~ "0603526", #not avail 2022 yet
                            state.abb == "NJ" & name == "jersey city" ~ "3436000",#being processed
                            TRUE ~ as.character(geo_id))) %>% 
  # #MN "st paul" - dont have yet, uploaded files.     
# 
#     add_row(state.abb = "MN", name = "st paul", year = 2021, net_pension_liability = 133080944, population = 307150)
  
  filter(geo_id %in% census_city_top100$geo_id) %>% 
  left_join(census_city_top100)

# identify missing 22: 
missing_city_22 <- census_city_top100 %>% filter(geo_id %in% setdiff(census_city_top100$geo_id, acfr_top_city_22$geo_id)) 

city_top100_3years <- acfr_top_city_21 %>% 
  rbind(acfr_top_city_20) %>% 
  rbind(acfr_top_city_22)

 #add_row(state.abb = "NY", name = "roschester", geo_id = "3663000") %>% 
  #add_row(state.abb = "CA", name = "san jose", geo_id = "0668000") %>% 
  # add_row(state.abb = "LA", name = "new orleans", geo_id = "2255000") %>% 
  # add_row(state.abb = "LA", name = "new orleans", geo_id = "2255000") %>% 
  # add_row(state.abb = "NJ", name = "newark", geo_id = "3451000") %>% 
  # add_row(state.abb = "NY", name = "buffalo", geo_id = "3611000") %>% 
  # add_row(state.abb = "PA", name = "philadelphia", geo_id = "4260000") %>% 
  # add_row(state.abb = "NY", name = "buffalo", geo_id = "3611000") %>% 
  # add_row(state.abb = "CA", name = "bakersfield", geo_id = "0603526") %>% 
  # add_row(state.abb = "MN", name = "st paul", geo_id = "2758000") %>% 
  # add_row(state.abb = "NJ", name = "jersey city", geo_id = "3436000") 

city_top100_3years %>% write.csv("output/top100_city_3years.csv")

datatable(city_top100_3years)
```
## Top 100 Cities: Net Pension Liabilities

```{r fig.width=15, fig.width=15}
city_top100_3years %>% 
  mutate(year = as.factor(year)) %>% 
  ggplot(aes(name, net_pension_liability), group = year) +
  geom_col(aes(fill = year), position = "dodge") +
  # scale_color_viridis(discrete=TRUE) +
  scale_y_continuous(breaks = c(5000000000, 10000000000, 15000000000),
                  label = c("$5B", "$10B","$15B")) +
  
    scale_fill_manual(values = c('#526A83', '#625377', '#68855C')) +
  
  labs(title = "Net Pension Liabilities of The top 100 City Governments in 3 years: 2020, 2021, 2022",
       x = "",
       y = "Net Pension Liabilities", 
       caption = "") +

  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) 
```

## Top 100 Cities: Net Pension Liabilities Per Person 

```{r fig.width=15, fig.width=15}
## Top 100 Cities Per person in 3 years 
city_top100_3years %>% #filter(name == "jacksonville")
  mutate(year = as.factor(year)) %>% #select(state.abb, name, net_pension_liability, population) %>% 
  mutate(npl_person = net_pension_liability/population) %>% 
  ggplot(aes(name, npl_person), group = year) +
  geom_col(aes(fill = year), position = "dodge") +
  # scale_color_viridis(discrete=TRUE) +
 # scale_y_continuous(breaks = c(5000000000, 10000000000, 15000000000),
    #              label = c("$5B", "$10B","$15B")) +
  
    scale_fill_manual(values = c('#526A83', '#625377', '#68855C')) +
  
  labs(title = "Net Pension Liabilities of The top 100 City Governments Per Person\nin 3 years: 2020, 2021, 2022",
       x = "",
       y = "Net Pension Liabilities", 
       caption = "") +

  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) 
```

## Entities at risk
1) Asset to liability ratio; 
2) Unrestricted - currently do not collect this
3) Current ratio: Current Assets / Current Liabilities --> Do not have current assets

```{r}
state_3years %>% select(net_pension_assets, net_pension_liability, state.abb) %>% 
  mutate(net_pension_liability = net_pension_liability + 1, 
         net_pension_assets = net_pension_assets + 1) %>% 
  mutate(np_asset_lia_ratio = net_pension_assets/net_pension_liability) %>% 
  arrange(desc(np_asset_lia_ratio)) %>% 

  ggplot(aes(state.abb, np_asset_lia_ratio, group = state.abb)) +
  geom_point() 
  coord_flip()


```

